<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR History Scanner</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* BASE STYLES */
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Lato', sans-serif; 
            background-color: #1a1a2e; /* Start Dark */
            color: white; 
        }

        /* FULLSCREEN SCREENS */
        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; display: none; flex-direction: column; 
            background-color: #1a1a2e; /* Screens have their own background */
        }
        .active-screen { display: flex; }

        /* THE 3D SCENE (Initially Hidden) */
        #ar-scene-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; 
            visibility: hidden; /* Hide until we start */
        }

        /* BUTTONS */
        .btn {
            background: linear-gradient(145deg, #f1c40f, #d4ac0d);
            border: none; padding: 15px 30px; margin: 10px;
            border-radius: 50px; font-weight: bold; font-size: 16px; color: #1a1a2e;
            box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3); font-family: 'Cinzel', serif;
        }
        .btn-secondary { background: #2c3e50; color: #f1c40f; border: 2px solid #f1c40f; }

        /* DEBUG / STATUS LOG (So we know what's happening) */
        #debug-log {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: rgba(255, 0, 0, 0.8); color: white; 
            font-size: 12px; padding: 5px; z-index: 99999;
            text-align: center; display: none;
        }

        /* SCAN OVERLAY */
        #scan-ui {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            z-index: 20; display: none; text-align: center; pointer-events: none;
        }
        #scan-ui button { pointer-events: auto; }
        
        /* SCREENS CSS */
        #menu-screen { align-items: center; justify-content: center; background: url('https://images.unsplash.com/photo-1599940824399-b87987ced7bb?q=80&w=1000') center/cover; }
        #info-screen { padding: 30px; overflow-y: auto; }
        .info-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 4px solid #f1c40f; }

    </style>
</head>
<body>

    <div id="debug-log">Status: Initializing...</div>

    <div id="ar-scene-container">
        <a-scene 
            mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/examples/image-tracking/assets/card-example/card.mind; autoStart: false; uiLoading: no; uiScanning: no;" 
            embedded 
            color-space="sRGB" 
            renderer="colorManagement: true, physicallyCorrectLights" 
            vr-mode-ui="enabled: false" 
            device-orientation-permission-ui="enabled: false">
            
            <a-assets>
                <a-asset-item id="hubback-model" src="./hubback.glb"></a-asset-item>
                <a-asset-item id="norman-model" src="./norman.glb"></a-asset-item>
            </a-assets>

            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

            <a-entity mindar-image-target="targetIndex: 0">
                <a-entity 
                    id="ar-model-entity"
                    gltf-model="#hubback-model" 
                    rotation="0 0 0" 
                    position="0 0 0" 
                    scale="0.5 0.5 0.5" 
                ></a-entity>
            </a-entity>
        </a-scene>
    </div>

    <div id="menu-screen" class="screen active-screen">
        <h1 style="font-size: 30px;">ARCHITECTS AR</h1>
        <p>Demo Mode</p>
        <button class="btn" onclick="openInfo('hubback')">HUBBACK</button>
        <button class="btn" onclick="openInfo('norman')">NORMAN</button>
    </div>

    <div id="info-screen" class="screen">
        <button class="btn-secondary" onclick="goBack()" style="padding: 5px 15px;">&larr; BACK</button>
        <h1 id="info-name">NAME</h1>
        <div class="info-card"><p id="info-desc">Description...</p></div>
        
        <button class="btn" onclick="startScanning()" style="width:100%">START CAMERA</button>
    </div>

    <div id="scan-ui">
        <div style="background:rgba(0,0,0,0.5); display:inline-block; padding:10px; border-radius:10px; margin-bottom:10px;">
            ðŸ“· Point at Target Image
        </div><br>
        <button class="btn btn-secondary" onclick="stopScanning()">STOP</button>
    </div>

    <script>
        // === LOGGER ===
        function log(msg) {
            const el = document.getElementById('debug-log');
            el.style.display = 'block';
            el.innerText = "Status: " + msg;
            console.log(msg);
        }

        // === 1. CHECK HTTPS ===
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            alert("STOP! You are not on HTTPS. Camera will be blocked. Please use Netlify or localhost.");
            log("ERROR: NOT HTTPS");
        }

        // === 2. DATA ===
        const db = {
            hubback: { name: "A.B. HUBBACK", desc: "Architect of Jamek Mosque.", model: "#hubback-model" },
            norman: { name: "A.C. NORMAN", desc: "Architect of Sultan Abdul Samad.", model: "#norman-model" }
        };
        let currentId = null;

        // === 3. NAVIGATION ===
        function openInfo(id) {
            currentId = id;
            document.getElementById('info-name').innerText = db[id].name;
            document.getElementById('info-desc').innerText = db[id].desc;
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('info-screen').classList.add('active-screen');
        }

        function goBack() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('menu-screen').classList.add('active-screen');
        }

        // === 4. CAMERA LOGIC ===
        function startScanning() {
            log("Requesting Camera...");

            // 1. Hide UI
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('scan-ui').style.display = 'block';

            // 2. Make Body Transparent (CRITICAL FIX)
            document.body.style.backgroundColor = 'transparent';

            // 3. Show Scene
            const container = document.getElementById('ar-scene-container');
            container.style.visibility = 'visible';

            // 4. Load Model
            const entity = document.getElementById('ar-model-entity');
            entity.setAttribute('gltf-model', db[currentId].model);

            // 5. Start MindAR System
            const scene = document.querySelector('a-scene');
            
            if (scene.systems['mindar-image-system']) {
                scene.systems['mindar-image-system'].start();
                log("Camera Started. Scan Image now.");
            } else {
                log("Error: AR System not found. Check Internet.");
                // Fallback: reload page if it fails hard
                setTimeout(() => { 
                    if(!scene.systems['mindar-image-system']) alert("AR Engine failed to load. Check internet connection."); 
                }, 2000);
            }
        }

        function stopScanning() {
            log("Stopping Camera...");
            const scene = document.querySelector('a-scene');
            scene.systems['mindar-image-system'].stop();

            // Reset UI
            document.getElementById('ar-scene-container').style.visibility = 'hidden';
            document.getElementById('scan-ui').style.display = 'none';
            document.body.style.backgroundColor = '#1a1a2e'; // Reset Background
            
            // Go back
            document.getElementById('info-screen').classList.add('active-screen');
        }
    </script>
</body>
</html>